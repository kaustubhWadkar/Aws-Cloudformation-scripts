AWSTemplateFormatVersion: '2010-09-09'
Description: Create ECR Repository, Lifecycle Policy, ECS Task Definition, tatget group
Parameters:
  ServiceName:
    Type: String
    Description: The service name you provide here will be used every where using proper sufix
  RepositoryName:
    Type: String
    Default: my-app-repo
  ContainerPort:
    Type: Number
    Default: 8080
  TaskCPU:
    Type: Number
    Default: 256
  TaskMemory:
    Type: Number
    Default: 512
  ApplicationOwner:
    Type: String
  ApplicationName:
    Type: String
  Environment:
    Type: String
    Default: uat
  RoleForTask:
    Type: String
    Default: arn:aws:iam::6120654659:role/Admin_role
  vpc:
    Type: String
    Default: vpc-0e5bb3100aafe64ff
    Description: Give here vpc id
  Subnets1:
    Type: String
    Default: subnet-0147fdc135e9ca628
    Description: Give Subnet_ 1 here
  Subnets2:
    Type: String
    Default: subnet-0b5670c12b2cf0d
    Description: Give Subnet_2 here
  SecurityGroupIds:
    Type: List<AWS::EC2::SecurityGroup::Id>
    Description: Provide one or more Security Group IDs
    Default: sg-007908b46787735,sg-02d9076d45ad54baa
  HealthCheckPath:
    Type: String
    Default: /
    Description: Give health check path here
  Protocol:
    Type: String
    Default: HTTP
    AllowedValues:
      - HTTP
      - HTTPS
    Description: here u need to give portoal http or https
  
  TargetGroupPort:
    Type: Number
    Default: 80
    AllowedValues:
      - 80
      - 443

  # target group health check portoal and ports
  HealthCheckProtocol:
    Type: String
    Default: HTTP
    AllowedValues:
      - HTTP
      - HTTPS
    Description: here u need to give portoal http or https
  
  # Listner

  ListenerArn:
    Type: String
    Default: arn:aws:elasticloadbalancing:us-east-1:612062459:listener/app/faclon-1/b2a7398d89a67e3e/b4a458c78eb06ef5
  
  PriorityOfListenrRule:
     Type: Number
     Description: Give listerner rule Priority number here
  
  HostHeadervalue:
     Type: String
     Default: xyz.hostname.com
  
  ContextPath:
     Type: String
     Default: /test
  
  ClusterName:
     Type: String
     Default: uat-faclon-cluster
  
  DesiredCount:
     Type: Number
     Default: 0




    
Resources:
  EcrRepo:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Ref RepositoryName
      ImageTagMutability: MUTABLE
      ImageScanningConfiguration:
        ScanOnPush: true
      LifecyclePolicy:
        LifecyclePolicyText: |
          {
            "rules": [
              {
                "rulePriority": 1,
                "description": "remove untagged images",
                "selection": {
                  "tagStatus": "untagged",
                  "countType": "imageCountMoreThan",
                  "countNumber": 5
                },
                "action": { "type": "expire" }
              }
            ]
          }
      Tags:
        - Key: Application Owner
          Value: !Ref ApplicationOwner
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref ApplicationName
  TaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub ${RepositoryName}-td
      Cpu: !Ref TaskCPU
      Memory: !Ref TaskMemory
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !Ref RoleForTask
      TaskRoleArn: !Ref RoleForTask
      ContainerDefinitions:
        - Name: !Ref ServiceName
          Image: !Sub ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${RepositoryName}:latest
          Essential: true
          PortMappings:
            - ContainerPort: !Ref ContainerPort
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Sub /ecs/${RepositoryName}-td
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs
      Tags:
        - Key: Application Owner
          Value: !Ref ApplicationOwner
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref ApplicationName
  TargetGroup1:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub tg-${ServiceName}-1
      Port: !Ref TargetGroupPort
      Protocol: !Ref Protocol
      TargetType: ip
      VpcId: !Ref vpc
      HealthCheckEnabled: true
      HealthCheckPath: !Ref HealthCheckPath
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: '200'
      Tags:
        - Key: Application Owner
          Value: !Ref ApplicationOwner
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref ApplicationName
  TargetGroup2:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub tg-${ServiceName}-2
      Port: !Ref TargetGroupPort
      Protocol: !Ref Protocol
      TargetType: ip
      VpcId: !Ref vpc
      HealthCheckEnabled: true
      HealthCheckPath: !Ref HealthCheckPath
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: '200'
      Tags:
        - Key: Application Owner
          Value: !Ref ApplicationOwner
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref ApplicationName
  
# ALB Listner rule add

  ListenerRule:
   Type: AWS::ElasticLoadBalancingV2::ListenerRule
   Properties:
    ListenerArn: !Ref ListenerArn
    Priority: !Ref PriorityOfListenrRule
    Conditions:
      - Field: host-header
        HostHeaderConfig:
          Values:
            - !Ref HostHeadervalue
      - Field: path-pattern
        PathPatternConfig:
          Values:
            - !Ref ContextPath
    Actions:
      - Type: forward
        ForwardConfig:
          TargetGroups:
            - TargetGroupArn: !Ref TargetGroup1
              Weight: 100
            - TargetGroupArn: !Ref TargetGroup2
              Weight: 0
  
#-------------------------------------------------------------


  ECSService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: !Ref ServiceName
      Cluster: !Ref ClusterName       # change if your cluster name is different
      LaunchType: FARGATE
      DesiredCount: 1
      TaskDefinition: !Ref TaskDefinition

      DeploymentController:
        Type: ECS   # Rolling update (no CodeDeploy)

      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100

      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          Subnets:
            - !Ref Subnets1
            - !Ref Subnets2
          SecurityGroups: !Ref SecurityGroupIds

      LoadBalancers:
        - ContainerName: !Ref ServiceName
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref TargetGroup1   # primary TG for rolling update

      Tags:
        - Key: Application Owner
          Value: !Ref ApplicationOwner
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: !Ref ApplicationName




Outputs:
  EcrRepositoryUri:
    Description: ECR Repository URL
    Value: !GetAtt EcrRepo.RepositoryUri
  TaskDefinitionArn:
    Description: ECS Task Definition ARN
    Value: !Ref TaskDefinition
  TargetGroup1Arn:
    Description: ARN of the first target group
    Value: !Ref TargetGroup1
  TargetGroup2Arn:
    Description: ARN of the second target group
    Value: !Ref TargetGroup2
